# Filmorate
## Визуализация схемы БД для хранения данных
  
![DB Scheme](db.png)  

## Схема SQL

```sql
CREATE TABLE rating (
  rating_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name varchar UNIQUE NOT NULL
);

CREATE TABLE films (
  film_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name varchar NOT NULL,
  description varchar,
  releaseDate date,
  duration integer NOT NULL CHECK (duration > 0),
  rating_id integer REFERENCES rating (rating_id) ON DELETE CASCADE
);

CREATE TABLE genres (
  genre_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name varchar UNIQUE NOT NULL
);

CREATE TABLE films_genre (
  film_id integer REFERENCES films (film_id) ON DELETE CASCADE NOT NULL,
  genre_id integer REFERENCES genres (genre_id) ON DELETE CASCADE NOT NULL,
  PRIMARY KEY (film_id, genre_id)
);

CREATE TABLE users (
  user_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  first_name varchar NOT NULL,
  last_name varchar,
  login varchar UNIQUE NOT NULL,
  email varchar,
  birthday date,
  EXCLUDE USING btree (lower(email) WITH =)
);

CREATE TABLE friendship (
  user1_id integer REFERENCES users (user_id) ON DELETE CASCADE NOT NULL,
  user2_id integer REFERENCES users (user_id) ON DELETE CASCADE NOT NULL,
  PRIMARY KEY (user1_id, user2_id)
);

CREATE TABLE likes (
  user_id integer REFERENCES users (user_id) ON DELETE CASCADE NOT NULL,
  film_id integer REFERENCES films (film_id) ON DELETE CASCADE NOT NULL,
  PRIMARY KEY (user_id, film_id)
);
```

## Примеры запросов к базе  
- Получение списка пользователей
```sql
SELECT first_name,  
       last_name,  
       login,  
       email  
FROM users  
ORDER BY last_name;
```

- Получение списка друзей и почитателей (тех, кто заявил его в друзья, но дружба не подтверждена) пользователя с `id = 1`
```sql
SELECT DISTINCT u.first_name,  
       u.last_name,  
       u.login,  
       u.email  
FROM users u 
INNER JOIN friendship f 
ON ((f.source_id = 1 AND f.destination_id = u.id)  
OR (f.destination_id = 1 AND f.source_id = u.id))
ORDER BY last_name;
```

- Получение списка почитателей пользователя с `id = 1` (друзья не в счёт!)
```sql
SELECT DISTINCT first_name,  
       last_name,  
       login,  
       email  
FROM users
WHERE id IN (
	SELECT source_id
	FROM friendship
	WHERE destination_id = 1
) AND id NOT IN (
	SELECT destination_id
	FROM friendship
	WHERE source_id = 1
)
ORDER BY last_name;
```  

- Получение списка подтверждённых друзей пользователя `id = 1`
```sql
SELECT DISTINCT first_name,  
       last_name,  
       login,  
       email  
FROM users
WHERE id IN (
	SELECT source_id
	FROM friendship
	WHERE destination_id = 1
) AND id IN (
	SELECT destination_id
	FROM friendship
	WHERE source_id = 1
)
ORDER BY last_name;
```

- Полулучение списка 10 фильмов в жанре `комедия` с наибольшим число лайков
```sql
SELECT f.name,
       COUNT(DISTINCT l.user_id) AS likes
FROM films f 
INNER JOIN likes l ON l.film_id = f.id
INNER JOIN films_genre fg ON fg.film_id = f.id
INNER JOIN genres g ON g.id = fg.genre_id
WHERE g.name = 'комедия'
GROUP BY f.id
ORDER BY likes DESC
LIMIT 10;
```

- Полулучение списка 10 фильмов с наибольшим число лайков, которые понравились пользователю `id = 1`
```sql
SELECT film.film_name,
       film.likes
FROM (
    SELECT f.name AS film_name,
           f.id AS id,
           COUNT(DISTINCT l.user_id) AS likes
    FROM films f
    INNER JOIN likes l ON l.film_id = f.id
    GROUP BY f.id
) AS film
WHERE film.id IN (
    SELECT id
    FROM films f
    INNER JOIN likes l ON l.film_id = f.id
    WHERE l.user_id = 1
)
ORDER BY film.likes DESC
LIMIT 10;
```